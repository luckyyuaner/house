<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.yuan.house.dao.CommentDao">

    <insert id="addCommentByTenant" parameterType="com.yuan.house.model.Comment">
        INSERT INTO comment
        (
        user_id, contract_id, info, url
        <if test="object.houseGrade != 0">
            , house_grade
        </if>
        )
        VALUES
        (
         #{object.userId},#{object.contractId}, #{object.info},
         #{object.url}
        <if test="object.houseGrade != 0">
            ,#{object.houseGrade}
        </if>
        )
    </insert>

    <update id="updateHouseGrade">
        UPDATE house
        SET grade = <![CDATA[grade+ (#{grade}-grade)/((select count(contract_id) from comment where contract_id =#{cid})+1)]]>
        WHERE house_id in (select house_id from contract where contract_id =#{cid})
    </update>

    <update id="updateLandlordGrade">
        UPDATE user
        SET reputation = <![CDATA[reputation+ (#{grade}-reputation)/((select count(user_id) from house where house_id in (select house_id from contract where contract_id = #{cid}))+1)]]>
        WHERE user_id in (select user_id from house where house_id in (select house_id from contract where contract_id =#{cid}))
    </update>

</mapper>